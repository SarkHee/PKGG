// Prisma schema for clans and clan members
// Save as prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model Clan {
  id           Int           @id @default(autoincrement())
  name         String        @unique
  leader       String
  description  String?
  announcement String?
  memberCount  Int
  avgScore     Int?
  mainStyle    String?
  
  // PUBG API 관련 필드들 추가
  pubgClanId   String?       @unique // PUBG API의 clan ID
  pubgClanTag  String?       // PUBG API의 clan tag
  pubgClanLevel Int?         // PUBG API의 clan level
  pubgMemberCount Int?       // PUBG API에서 가져온 멤버 수
  lastSynced   DateTime?     // 마지막 PUBG API 동기화 시간
  
  // 지역/국가 구분 필드들
  region       String?       // 추정 지역 (KR, NA, EU, AS, OC 등)
  isKorean     Boolean?      // 한국 클랜 여부 추정
  shardDistribution String? // 멤버들의 shard 분포 (JSON)
  
  members      ClanMember[]
}

model ClanMember {
  id             Int     @id @default(autoincrement())
  nickname       String
  score          Int
  style          String
  avgDamage      Float
  avgKills       Float   @default(0)
  avgAssists     Float   @default(0)
  avgSurviveTime Float   @default(0)
  winRate        Float   @default(0)
  top10Rate      Float   @default(0)
  clanId         Int
  clan           Clan    @relation(fields: [clanId], references: [id])
  
  // PUBG API 관련 필드들 추가
  pubgClanId     String? // PUBG API의 clan ID (예: "clan.eb5c32a3cc484b59981f9c61e9ea2747")
  pubgPlayerId   String? // PUBG API의 player ID
  pubgShardId    String? // PUBG API의 shard ID (steam, kakao 등)
  lastUpdated    DateTime @default(now())
  
  matches        PlayerMatch[]
  modeStats      PlayerModeStats[]
}

model PlayerMatch {
  id           Int      @id @default(autoincrement())
  clanMember   ClanMember @relation(fields: [clanMemberId], references: [id])
  clanMemberId Int
  matchId      String   // PUBG match id
  mode         String   // solo/duo/squad 등
  mapName      String?
  placement    Int
  kills        Int
  assists      Int
  // UBD 클랜 멤버에 'soo5woo', 'a-ing-a-ing' 추가
  // ...existing code...
  damage       Float
  surviveTime  Float
  createdAt    DateTime @default(now())
}

model PlayerModeStats {
  id           Int      @id @default(autoincrement())
  clanMember   ClanMember @relation(fields: [clanMemberId], references: [id])
  clanMemberId Int
  mode         String   // solo/duo/squad/fpp/tpp 등
  matches      Int
  wins         Int
  top10s       Int
  avgDamage    Float
  avgKills     Float
  avgAssists   Float
  winRate      Float
  top10Rate    Float
}

// 포럼 관련 모델들
model ForumCategory {
  id          String     @id
  name        String
  description String
  icon        String
  color       String
  order       Int        @default(0)
  posts       ForumPost[]
  createdAt   DateTime   @default(now())
}

model ForumPost {
  id          Int         @id @default(autoincrement())
  title       String
  content     String      // 게시글 내용 (Markdown 지원)
  preview     String?     // 미리보기 텍스트
  author      String      // 작성자 닉네임
  categoryId  String
  category    ForumCategory @relation(fields: [categoryId], references: [id])
  
  // 통계 정보
  views       Int         @default(0)
  likes       Int         @default(0)
  isPinned    Boolean     @default(false)  // 공지/고정글 여부
  isLocked    Boolean     @default(false)  // 댓글 잠금 여부
  
  replies     ForumReply[]
  likedBy     ForumLike[]
  
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
}

model ForumReply {
  id        Int       @id @default(autoincrement())
  content   String
  author    String    // 댓글 작성자 닉네임
  postId    Int
  post      ForumPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  parentId  Int?      // 대댓글을 위한 부모 댓글 ID
  parent    ForumReply? @relation("ReplyToReply", fields: [parentId], references: [id])
  children  ForumReply[] @relation("ReplyToReply")
  
  likes     Int       @default(0)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model ForumLike {
  id        Int       @id @default(autoincrement())
  postId    Int
  post      ForumPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  author    String    // 좋아요를 누른 사용자 닉네임
  createdAt DateTime  @default(now())
  
  @@unique([postId, author]) // 중복 좋아요 방지
}

model ForumUser {
  id               Int       @id @default(autoincrement())
  username         String    @unique
  email            String    @unique
  violationCount   Int       @default(0)
  lastViolation    DateTime?
  violationType    String?   // PROFANITY, SPAM, MANUAL_BAN 등
  violationContent String?   // 위반 내용 일부
  isBanned         Boolean   @default(false)
  banReason        String?
  banUntil         DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  @@map("forum_users")
}

model PubgNews {
  id            Int       @id @default(autoincrement())
  title         String    // 공지사항 제목
  link          String    @unique // 원본 URL (url -> link로 통일)
  url           String?   // 기존 호환성을 위한 필드
  category      String?   // 카테고리 (이벤트, 업데이트, 공지사항 등)
  publishedAt   DateTime? // 발행일 (publishDate -> publishedAt로 통일)
  publishDate   DateTime? // 기존 호환성을 위한 필드
  imageUrl      String?   // 썸네일 이미지 URL
  summary       String?   // 요약 내용
  
  // 크롤링 정보
  source        String    @default("PUBG_OFFICIAL") // PUBG_OFFICIAL, STEAM_PUBG
  views         Int       @default(0) // 조회수
  
  // 관리 정보
  isActive      Boolean   @default(true)
  priority      Int       @default(0) // 우선순위 (높은 숫자가 더 중요)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@map("pubg_news")
}

// 랭킹 업데이트 로그 모델
model RankingUpdateLog {
  id             Int       @id @default(autoincrement())
  updateType     String    // 업데이트 타입 (clan_ranking, player_ranking 등)
  updateTime     DateTime  // 업데이트 시간
  status         String    // 상태 (success, error)
  updatedCount   Int       @default(0) // 업데이트된 항목 수
  errorMessage   String?   // 오류 메시지 (있는 경우)
  details        String?   // 추가 상세 정보 (JSON 형태)
  
  createdAt      DateTime  @default(now())
  
  @@map("ranking_update_logs")
}

// 사이트 공지사항 모델
model Notice {
  id           Int       @id @default(autoincrement())
  title        String    // 공지사항 제목
  content      String    // 공지사항 내용 (Markdown 지원)
  summary      String?   // 요약/미리보기 텍스트
  type         String    // 공지 타입 (UPDATE, MAINTENANCE, EVENT, GENERAL)
  priority     String    @default("NORMAL") // 우선순위 (HIGH, NORMAL, LOW)
  isActive     Boolean   @default(true) // 활성화 여부
  isPinned     Boolean   @default(false) // 상단 고정 여부
  showUntil    DateTime? // 표시 종료 시간 (선택적)
  author       String    @default("관리자") // 작성자
  views        Int       @default(0) // 조회수
  
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  
  @@map("notices")
}

// AI 코칭 시스템 모델들
model PlayerAnalysis {
  id                Int       @id @default(autoincrement())
  playerNickname    String
  playerServer      String
  
  // 플레이 스타일 분석
  playStyle         String    // AGGRESSIVE, PASSIVE, BALANCED, SNIPER, SUPPORT
  playstyleScore    Float     // 0-100 스타일 확신도
  
  // 강점과 약점
  strengths         String    // JSON 배열 형태로 저장
  weaknesses        String    // JSON 배열 형태로 저장
  
  // 통계 기반 분석
  killDeathRatio    Float
  damagePerGame     Float
  survivalRate      Float
  aggressionIndex   Float     // 공격성 지수
  consistencyIndex  Float     // 일관성 지수
  
  // AI 추천사항
  recommendations   String    // JSON 형태로 저장
  trainingPlan      String    // 맞춤형 훈련 계획
  
  lastAnalyzed      DateTime  @default(now())
  
  @@unique([playerNickname, playerServer])
  @@map("player_analyses")
}

model CoachingTip {
  id            Int       @id @default(autoincrement())
  category      String    // AIM, POSITIONING, STRATEGY, TEAMWORK, SURVIVAL
  playStyle     String    // 해당하는 플레이 스타일
  title         String    // 팁 제목
  description   String    // 상세 설명
  difficulty    String    // BEGINNER, INTERMEDIATE, ADVANCED
  priority      Int       @default(1) // 1-5 우선순위
  
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  
  @@map("coaching_tips")
}

model TrainingSession {
  id                Int       @id @default(autoincrement())
  playerNickname    String
  playerServer      String
  
  // 훈련 세션 정보
  sessionType       String    // AIM_TRAINING, POSITIONING, STRATEGY, etc.
  targetSkill       String    // 개선 목표 스킬
  duration          Int       // 권장 훈련 시간 (분)
  
  // 훈련 내용
  exercises         String    // JSON 형태 훈련 내용
  goals             String    // JSON 형태 목표 설정
  
  // 진행 상황
  status           String     @default("PENDING") // PENDING, IN_PROGRESS, COMPLETED
  completedAt      DateTime?
  
  createdAt        DateTime   @default(now())
  
  @@map("training_sessions")
}